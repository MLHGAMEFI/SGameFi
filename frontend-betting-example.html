<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGameFi ä¸‹æ³¨æ¸¸æˆ</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .game-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
        }

        .section-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .choice-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .choice-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 500;
        }

        .choice-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .choice-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .bet-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .bet-button:hover {
            transform: translateY(-2px);
        }

        .bet-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .wallet-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .wallet-info h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .bet-history {
            margin-top: 30px;
        }

        .bet-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .bet-item.won {
            border-left-color: #28a745;
        }

        .bet-item.lost {
            border-left-color: #dc3545;
        }

        .connect-wallet {
            text-align: center;
            padding: 40px;
        }

        .connect-btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .connect-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² SGameFi ä¸‹æ³¨æ¸¸æˆ</h1>
            <p>å•åŒæ•°æŠ•æ³¨ â€¢ èµ”ç‡ 1:1.9</p>
        </div>

        <div id="connectWallet" class="connect-wallet">
            <h2>è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ</h2>
            <p style="margin: 20px 0; color: #666;">è¯·ç¡®ä¿æ‚¨å·²è¿æ¥åˆ°Sonicæµ‹è¯•ç½‘</p>
            <button class="connect-btn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
        </div>

        <div id="gameInterface" style="display: none;">
            <!-- é’±åŒ…ä¿¡æ¯ -->
            <div class="wallet-info">
                <h3>é’±åŒ…ä¿¡æ¯</h3>
                <div class="balance-item">
                    <span>åœ°å€:</span>
                    <span id="walletAddress">-</span>
                </div>
                <div class="balance-item">
                    <span>S ä½™é¢:</span>
                    <span id="nativeBalance">-</span>
                </div>
                <div class="balance-item">
                    <span>MLH ä½™é¢:</span>
                    <span id="mlhBalance">-</span>
                </div>
                <div class="balance-item">
                    <span>MLHG ä½™é¢:</span>
                    <span id="mlhgBalance">-</span>
                </div>
            </div>

            <!-- ä¸‹æ³¨åŒºåŸŸ -->
            <div class="game-section">
                <div class="section-title">ğŸ¯ å¼€å§‹ä¸‹æ³¨</div>
                
                <div class="form-group">
                    <label>é€‰æ‹©ä»£å¸:</label>
                    <select id="tokenSelect">
                        <option value="native">S (åŸç”Ÿä»£å¸)</option>
                        <option value="mlh">MLH ä»£å¸</option>
                        <option value="mlhg">MLHG ä»£å¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æŠ•æ³¨é‡‘é¢ (1-1000):</label>
                    <input type="number" id="betAmount" min="1" max="1000" step="0.1" placeholder="è¾“å…¥æŠ•æ³¨é‡‘é¢">
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©å•åŒæ•°:</label>
                    <div class="choice-buttons">
                        <div class="choice-btn" onclick="selectChoice(true)" id="evenBtn">
                            <div style="font-size: 1.2em; margin-bottom: 5px;">ğŸ¯ åŒæ•°</div>
                            <div style="font-size: 0.9em; color: #666;">2, 4, 6, 8, 10</div>
                        </div>
                        <div class="choice-btn" onclick="selectChoice(false)" id="oddBtn">
                            <div style="font-size: 1.2em; margin-bottom: 5px;">ğŸ² å•æ•°</div>
                            <div style="font-size: 0.9em; color: #666;">1, 3, 5, 7, 9</div>
                        </div>
                    </div>
                </div>

                <button class="bet-button" onclick="placeBet()" id="betButton">ğŸš€ å¼€å§‹ä¸‹æ³¨</button>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="statusMessage" style="display: none;"></div>

            <!-- æŠ•æ³¨å†å² -->
            <div class="bet-history">
                <div class="section-title">ğŸ“Š æŠ•æ³¨å†å²</div>
                <div id="betHistoryList">
                    <p style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŠ•æ³¨è®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦é…ç½®
        const SONIC_TESTNET_CONFIG = {
            chainId: '0xDEDE', // 57054 in hex
            chainName: 'Sonic Blaze Testnet',
            nativeCurrency: {
                name: 'Sonic',
                symbol: 'S',
                decimals: 18
            },
            rpcUrls: ['https://rpc.blaze.soniclabs.com'],
            blockExplorerUrls: ['https://testnet.sonicscan.org/']
        };

        // åˆçº¦åœ°å€ (éœ€è¦æ›¿æ¢ä¸ºå®é™…éƒ¨ç½²çš„åœ°å€)
        const CONTRACT_ADDRESSES = {
            BETTING_CONTRACT: '0x0000000000000000000000000000000000000000', // æ›¿æ¢ä¸ºå®é™…åœ°å€
            MLH_TOKEN: '0x0A27117Af64E4585d899cC4aAD96A982f3Fa85FF',
            MLHG_TOKEN: '0xbca3aEC27772B6dD9aB68cF0a3F3d084f39e8dfb'
        };

        // åˆçº¦ABI (ç®€åŒ–ç‰ˆ)
        const BETTING_CONTRACT_ABI = [
            "function placeBet(address tokenAddress, uint256 betAmount, bool isEvenChoice) external payable",
            "function getBetInfo(uint256 requestId) external view returns (tuple(uint256 requestId, address player, address tokenAddress, uint256 betAmount, bool isEvenChoice, uint8 status, uint256 createdAt, uint256 settledAt, bool diceResult, uint256 payoutAmount))",
            "function getPlayerBets(address player) external view returns (uint256[])",
            "function getContractBalance(address tokenAddress) external view returns (uint256)",
            "event BetConfirmed(uint256 indexed requestId, address indexed player, address tokenAddress, uint256 betAmount, bool isEvenChoice, uint256 createdAt)",
            "event BetSettled(uint256 indexed requestId, address indexed player, uint256 betAmount, uint256 payoutAmount, bool playerChoice, bool diceResult, bool isWinner)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let bettingContract;
        let userAddress;
        let selectedChoice = null;

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('è¯·å®‰è£… MetaMask é’±åŒ…', 'error');
                    return;
                }

                // è¯·æ±‚è¿æ¥é’±åŒ…
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 57054) {
                    await switchToSonicTestnet();
                }

                // åˆå§‹åŒ–åˆçº¦
                bettingContract = new ethers.Contract(
                    CONTRACT_ADDRESSES.BETTING_CONTRACT,
                    BETTING_CONTRACT_ABI,
                    signer
                );

                // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('gameInterface').style.display = 'block';

                // æ›´æ–°ç•Œé¢
                await updateWalletInfo();
                await loadBetHistory();

                showStatus('é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showStatus('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ‡æ¢åˆ°Sonicæµ‹è¯•ç½‘
        async function switchToSonicTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SONIC_TESTNET_CONFIG.chainId }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [SONIC_TESTNET_CONFIG]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        async function updateWalletInfo() {
            try {
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);

                // è·å–åŸç”Ÿä»£å¸ä½™é¢
                const nativeBalance = await provider.getBalance(userAddress);
                document.getElementById('nativeBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(nativeBalance)).toFixed(4) + ' S';

                // è·å–ERC20ä»£å¸ä½™é¢
                const mlhContract = new ethers.Contract(CONTRACT_ADDRESSES.MLH_TOKEN, ERC20_ABI, provider);
                const mlhgContract = new ethers.Contract(CONTRACT_ADDRESSES.MLHG_TOKEN, ERC20_ABI, provider);

                const mlhBalance = await mlhContract.balanceOf(userAddress);
                const mlhgBalance = await mlhgContract.balanceOf(userAddress);

                document.getElementById('mlhBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(mlhBalance)).toFixed(4) + ' MLH';
                document.getElementById('mlhgBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(mlhgBalance)).toFixed(4) + ' MLHG';
            } catch (error) {
                console.error('æ›´æ–°é’±åŒ…ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // é€‰æ‹©å•åŒæ•°
        function selectChoice(isEven) {
            selectedChoice = isEven;
            
            document.getElementById('evenBtn').classList.remove('active');
            document.getElementById('oddBtn').classList.remove('active');
            
            if (isEven) {
                document.getElementById('evenBtn').classList.add('active');
            } else {
                document.getElementById('oddBtn').classList.add('active');
            }
        }

        // ä¸‹æ³¨
        async function placeBet() {
            try {
                const tokenSelect = document.getElementById('tokenSelect').value;
                const betAmount = document.getElementById('betAmount').value;
                
                if (!betAmount || betAmount < 1 || betAmount > 1000) {
                    showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•æ³¨é‡‘é¢ (1-1000)', 'error');
                    return;
                }
                
                if (selectedChoice === null) {
                    showStatus('è¯·é€‰æ‹©å•æ•°æˆ–åŒæ•°', 'error');
                    return;
                }

                const betAmountWei = ethers.utils.parseEther(betAmount.toString());
                let tokenAddress;
                let value = '0';

                // ç¡®å®šä»£å¸åœ°å€å’Œæ”¯ä»˜æ–¹å¼
                if (tokenSelect === 'native') {
                    tokenAddress = ethers.constants.AddressZero;
                    value = betAmountWei;
                } else if (tokenSelect === 'mlh') {
                    tokenAddress = CONTRACT_ADDRESSES.MLH_TOKEN;
                    // æ£€æŸ¥å¹¶æˆæƒä»£å¸
                    await approveToken(tokenAddress, betAmountWei);
                } else if (tokenSelect === 'mlhg') {
                    tokenAddress = CONTRACT_ADDRESSES.MLHG_TOKEN;
                    // æ£€æŸ¥å¹¶æˆæƒä»£å¸
                    await approveToken(tokenAddress, betAmountWei);
                }

                showStatus('æ­£åœ¨æäº¤æŠ•æ³¨...', 'info');
                document.getElementById('betButton').disabled = true;

                // è°ƒç”¨åˆçº¦ä¸‹æ³¨
                const tx = await bettingContract.placeBet(
                    tokenAddress,
                    betAmountWei,
                    selectedChoice,
                    { value: value }
                );

                showStatus('æŠ•æ³¨å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                
                const receipt = await tx.wait();
                showStatus('æŠ•æ³¨æˆåŠŸ! ç­‰å¾…éšæœºæ•°ç»“æœ...', 'success');

                // é‡ç½®è¡¨å•
                document.getElementById('betAmount').value = '';
                selectedChoice = null;
                document.getElementById('evenBtn').classList.remove('active');
                document.getElementById('oddBtn').classList.remove('active');

                // æ›´æ–°ç•Œé¢
                await updateWalletInfo();
                await loadBetHistory();

            } catch (error) {
                console.error('ä¸‹æ³¨å¤±è´¥:', error);
                showStatus('ä¸‹æ³¨å¤±è´¥: ' + error.message, 'error');
            } finally {
                document.getElementById('betButton').disabled = false;
            }
        }

        // æˆæƒä»£å¸
        async function approveToken(tokenAddress, amount) {
            const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
            
            const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESSES.BETTING_CONTRACT);
            
            if (allowance.lt(amount)) {
                showStatus('æ­£åœ¨æˆæƒä»£å¸ä½¿ç”¨...', 'info');
                const approveTx = await tokenContract.approve(CONTRACT_ADDRESSES.BETTING_CONTRACT, amount);
                await approveTx.wait();
                showStatus('ä»£å¸æˆæƒæˆåŠŸ', 'success');
            }
        }

        // åŠ è½½æŠ•æ³¨å†å²
        async function loadBetHistory() {
            try {
                const requestIds = await bettingContract.getPlayerBets(userAddress);
                const historyList = document.getElementById('betHistoryList');
                
                if (requestIds.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŠ•æ³¨è®°å½•</p>';
                    return;
                }

                let historyHtml = '';
                
                for (let i = requestIds.length - 1; i >= 0; i--) {
                    const requestId = requestIds[i];
                    const betInfo = await bettingContract.getBetInfo(requestId);
                    
                    const statusText = getStatusText(betInfo.status);
                    const statusClass = getStatusClass(betInfo.status);
                    const choiceText = betInfo.isEvenChoice ? 'åŒæ•°' : 'å•æ•°';
                    const amount = ethers.utils.formatEther(betInfo.betAmount);
                    const payout = betInfo.payoutAmount.gt(0) ? ethers.utils.formatEther(betInfo.payoutAmount) : '0';
                    
                    historyHtml += `
                        <div class="bet-item ${statusClass}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>æŠ•æ³¨ #${requestId.toString()}</strong>
                                <span class="status-badge">${statusText}</span>
                            </div>
                            <div>é€‰æ‹©: ${choiceText} | é‡‘é¢: ${amount}</div>
                            ${betInfo.payoutAmount.gt(0) ? `<div>å¥–é‡‘: ${payout}</div>` : ''}
                        </div>
                    `;
                }
                
                historyList.innerHTML = historyHtml;
            } catch (error) {
                console.error('åŠ è½½æŠ•æ³¨å†å²å¤±è´¥:', error);
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                0: 'ç­‰å¾…ä¸­',
                1: 'å·²ç¡®è®¤',
                2: 'ä¸­å¥– ğŸ‰',
                3: 'æœªä¸­å¥–',
                4: 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            if (status === 2) return 'won';
            if (status === 3) return 'lost';
            return '';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                location.reload();
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
    </script>
</body>
</html>