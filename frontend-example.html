<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGameFi ä¸‹æ³¨åˆçº¦ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-bar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .betting-section {
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .radio-item input[type="radio"]:checked + .radio-label {
            color: #667eea;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .bet-history {
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .bet-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .bet-item.winner {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .bet-item.loser {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .bet-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #alertContainer {
            margin-bottom: 15px;
        }

        #alertContainer:empty {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .status-bar {
                flex-direction: column;
            }

            .radio-group {
                flex-direction: column;
                align-items: center;
            }

            .bet-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² SGameFi ä¸‹æ³¨æ¸¸æˆ</h1>
            <p>åŸºäºæ™ºèƒ½åˆçº¦çš„å•åŒæ•°æŠ•æ³¨æ¸¸æˆ</p>
        </div>

        <!-- è¿æ¥çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">é’±åŒ…çŠ¶æ€</div>
                <div class="status-value" id="walletStatus">æœªè¿æ¥</div>
            </div>
            <div class="status-item">
                <div class="status-label">ç½‘ç»œ</div>
                <div class="status-value" id="networkStatus">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">ä½™é¢</div>
                <div class="status-value" id="balance">0 S</div>
            </div>
            <div class="status-item">
                <div class="status-label">åˆçº¦çŠ¶æ€</div>
                <div class="status-value" id="contractStatus">æœªè¿æ¥</div>
            </div>
        </div>

        <!-- è¿æ¥é’±åŒ…æŒ‰é’® -->
        <div class="betting-section" id="connectSection">
            <div id="alertContainer"></div>
            <div class="section-title">è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ</div>
            <button class="btn" onclick="connectWallet()">è¿æ¥ MetaMask</button>
        </div>

        <!-- æŠ•æ³¨åŒºåŸŸ -->
        <div class="betting-section hidden" id="bettingSection">
            <div class="section-title">ğŸ¯ ä¸‹æ³¨åŒºåŸŸ</div>
            
            <div id="alertContainer"></div>

            <div class="form-group">
                <label class="form-label">é€‰æ‹©ä»£å¸ç±»å‹</label>
                <select class="form-control" id="tokenSelect">
                    <option value="native">åŸç”Ÿä»£å¸ (S)</option>
                    <option value="0x0A27117Af64E4585d899cC4aAD96A982f3Fa85FF">MLH ä»£å¸</option>
                    <option value="0xbca3aEC27772B6dD9aB68cF0a3F3d084f39e8dfb">MLHG ä»£å¸</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">æŠ•æ³¨é‡‘é¢ (1-1000)</label>
                <input type="number" class="form-control" id="betAmount" min="1" max="1000" value="10" placeholder="è¾“å…¥æŠ•æ³¨é‡‘é¢">
            </div>

            <div class="form-group">
                <label class="form-label">é€‰æ‹©ä½ çš„é¢„æµ‹</label>
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="prediction" value="true" checked>
                        <span class="radio-label">ğŸ² åŒæ•° (2,4,6,8,10)</span>
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="prediction" value="false">
                        <span class="radio-label">ğŸ¯ å•æ•° (1,3,5,7,9)</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>æŠ•æ³¨é‡‘é¢:</span>
                        <span id="displayBetAmount">10 S</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>VRF è´¹ç”¨:</span>
                        <span id="displayVrfFee">0.001 S</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>æ€»è®¡:</span>
                        <span id="displayTotal">10.001 S</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; color: #28a745;">
                        <span>ä¸­å¥–å¯å¾—:</span>
                        <span id="displayPayout">19 S</span>
                    </div>
                </div>
            </div>

            <button class="btn" id="placeBetBtn" onclick="placeBet()">ğŸ² ä¸‹æ³¨</button>
        </div>

        <!-- æŠ•æ³¨å†å² -->
        <div class="bet-history hidden" id="historySection">
            <div class="section-title">ğŸ“Š æˆ‘çš„æŠ•æ³¨è®°å½•</div>
            <div id="betHistoryContainer">
                <div style="text-align: center; color: #666; padding: 20px;">
                    æš‚æ— æŠ•æ³¨è®°å½•
                </div>
            </div>
            <button class="btn btn-secondary" onclick="refreshHistory()">åˆ·æ–°è®°å½•</button>
        </div>
    </div>

    <!-- ä½¿ç”¨æ›´å¯é çš„CDNæº -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
    <!-- å¤‡ç”¨CDNæº -->
    <script>
        // æ£€æŸ¥ethersæ˜¯å¦åŠ è½½æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æº
        if (typeof ethers === 'undefined') {
            console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = function() {
                console.log('å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
                // é‡æ–°åˆå§‹åŒ–åº”ç”¨
                if (typeof initializeApp === 'function') {
                    initializeApp();
                }
            };
            script.onerror = function() {
                console.error('æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¿ç•™è¿æ¥æŒ‰é’®
                const alertContainer = document.getElementById('alertContainer') || document.createElement('div');
                if (!document.getElementById('alertContainer')) {
                    alertContainer.id = 'alertContainer';
                    const connectSection = document.getElementById('connectSection');
                    connectSection.insertBefore(alertContainer, connectSection.firstChild);
                }
                alertContainer.innerHTML = `
                    <div class="alert alert-error">
                        <strong>ç½‘ç»œè¿æ¥é”™è¯¯</strong><br>
                        æ— æ³•åŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚<br>
                        <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 10px;">åˆ·æ–°é¡µé¢é‡è¯•</button>
                    </div>
                `;
            };
            document.head.appendChild(script);
        }
    </script>
    <script>
        // åˆçº¦é…ç½®
        const SONIC_TESTNET = {
            chainId: '0xDEF6', // 57054
            chainName: 'Sonic Blaze Testnet',
            nativeCurrency: {
                name: 'Sonic',
                symbol: 'S',
                decimals: 18
            },
            rpcUrls: ['https://rpc.blaze.soniclabs.com'],
            blockExplorerUrls: ['https://testnet.sonicscan.org/']
        };

        // åˆçº¦åœ°å€ (å·²æ›´æ–°ä¸ºå®é™…éƒ¨ç½²çš„åœ°å€)
        const BETTING_CONTRACT_ADDRESS = '0xB3f8b9631e91d67e681f578b2967bb00dD0Ce495'; // BettingContractåˆçº¦åœ°å€
        
        // åˆçº¦ ABI (ç®€åŒ–ç‰ˆ)
        const BETTING_CONTRACT_ABI = [
            "function placeBetNative(bool predictedIsEven) external payable",
            "function placeBetToken(address tokenAddress, uint256 amount, bool predictedIsEven) external payable",
            "function requestDiceRoll(uint256 betId) external",
            "function getBetRecord(uint256 betId) external view returns (tuple(address player, uint256 amount, address tokenAddress, bool predictedIsEven, uint256 blockNumber, uint256 diceRequestId, bool isSettled, bool isWinner, uint256 timestamp, bool diceRollCompleted))",
            "function getPlayerBets(address player) external view returns (uint256[])",
            "function canRequestDiceRoll(uint256 betId) external view returns (bool)",
            "function vrfFee() external view returns (uint256)",
            "function nextBetId() external view returns (uint256)",
            "event BetPlaced(uint256 indexed betId, address indexed player, address tokenAddress, uint256 amount, bool predictedIsEven, uint256 timestamp)",
            "event BetSettled(uint256 indexed betId, address indexed player, uint256 diceRequestId, bool actualIsEven, bool isWinner, uint256 payout, uint256 timestamp)",
            "event DiceRollRequested(uint256 indexed betId, uint256 indexed diceRequestId, uint256 blockNumber)"
        ];

        // ERC20 ABI
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let bettingContract;
        let userAddress;
        let vrfFee;

        /**
         * é‡ç½®UIåˆ°åˆå§‹çŠ¶æ€
         */
        function resetUIToInitialState() {
            // æ˜¾ç¤ºè¿æ¥åŒºåŸŸï¼Œéšè—å…¶ä»–åŒºåŸŸ
            document.getElementById('connectSection').classList.remove('hidden');
            document.getElementById('bettingSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            
            // é‡ç½®çŠ¶æ€æ˜¾ç¤º
            document.getElementById('walletStatus').textContent = 'æœªè¿æ¥';
            document.getElementById('networkStatus').textContent = '-';
            document.getElementById('balance').textContent = '0 S';
            document.getElementById('contractStatus').textContent = 'æœªè¿æ¥';
            
            // é‡ç½®è¿æ¥æŒ‰é’®
            const connectBtn = document.querySelector('#connectSection .btn');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.textContent = 'è¿æ¥ MetaMask';
                connectBtn.onclick = connectWallet;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨å‡½æ•°
        async function initializeApp() {
            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿ethersåº“åŠ è½½å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ£€æŸ¥ethersåº“æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof ethers === 'undefined') {
                console.log('ethersåº“æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                return; // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œç­‰å¾…åº“åŠ è½½å®Œæˆ
            }
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            const existingAlert = document.getElementById('alertContainer');
            if (existingAlert && existingAlert.innerHTML.includes('ç½‘ç»œè¿æ¥é”™è¯¯')) {
                existingAlert.innerHTML = '';
            }
            
            // æ£€æŸ¥MetaMask
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask å·²å®‰è£…');
                
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    } else {
                        showAlert('è¯·ç‚¹å‡»"è¿æ¥ MetaMask"æŒ‰é’®å¼€å§‹ä½¿ç”¨', 'info');
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥è´¦æˆ·å¤±è´¥:', error);
                    showAlert('MetaMask è¿æ¥æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿ MetaMask æ­£å¸¸è¿è¡Œ', 'error');
                }
            } else {
                // æ˜¾ç¤ºMetaMaskå®‰è£…æŒ‡å¯¼ï¼Œä½†ä¿ç•™åŸæœ‰çš„è¿æ¥æŒ‰é’®ç»“æ„
                const connectSection = document.getElementById('connectSection');
                const alertContainer = document.getElementById('alertContainer') || document.createElement('div');
                if (!document.getElementById('alertContainer')) {
                    alertContainer.id = 'alertContainer';
                    connectSection.insertBefore(alertContainer, connectSection.firstChild);
                }
                
                alertContainer.innerHTML = `
                    <div class="alert alert-info">
                        <strong>ğŸ¦Š éœ€è¦å®‰è£… MetaMask</strong><br>
                        MetaMask æ˜¯ä¸€ä¸ªæµè§ˆå™¨é’±åŒ…æ’ä»¶ï¼Œç”¨äºä¸åŒºå—é“¾åº”ç”¨äº¤äº’ã€‚<br>
                        <a href="https://metamask.io" target="_blank" style="color: #667eea;">ç‚¹å‡»è¿™é‡Œä¸‹è½½ MetaMask</a>
                    </div>
                `;
                
                // æ›´æ–°è¿æ¥æŒ‰é’®æ–‡æœ¬å’ŒåŠŸèƒ½
                const connectBtn = connectSection.querySelector('.btn');
                if (connectBtn) {
                    connectBtn.textContent = 'å‰å¾€ä¸‹è½½ MetaMask';
                    connectBtn.onclick = () => window.open('https://metamask.io', '_blank');
                }
            }

            // æ›´æ–°æ˜¾ç¤ºé‡‘é¢
            updateDisplayAmounts();
        }

        /**
         * è®¾ç½®MetaMaskäº‹ä»¶ç›‘å¬å™¨
         */
        function setupMetaMaskListeners() {
            if (typeof window.ethereum !== 'undefined') {
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                window.ethereum.on('accountsChanged', function (accounts) {
                    console.log('è´¦æˆ·å˜åŒ–:', accounts);
                    if (accounts.length === 0) {
                        // ç”¨æˆ·æ–­å¼€äº†è¿æ¥
                        resetUIToInitialState();
                        showAlert('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
                    } else {
                        // ç”¨æˆ·åˆ‡æ¢äº†è´¦æˆ·ï¼Œé‡æ–°è¿æ¥
                        location.reload();
                    }
                });

                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', function (chainId) {
                    console.log('ç½‘ç»œå˜åŒ–:', chainId);
                    location.reload();
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // é‡ç½®åˆ°åˆå§‹çŠ¶æ€
            resetUIToInitialState();
            
            // è®¾ç½®MetaMaskäº‹ä»¶ç›‘å¬å™¨
            setupMetaMaskListeners();
            
            await initializeApp();
            
            // å¦‚æœethersåº“æœªåŠ è½½ï¼Œæ¯éš”2ç§’é‡è¯•ä¸€æ¬¡
            const retryInterval = setInterval(async () => {
                if (typeof ethers !== 'undefined') {
                    clearInterval(retryInterval);
                    await initializeApp();
                }
            }, 2000);
            
            // 10ç§’ååœæ­¢é‡è¯•
            setTimeout(() => {
                clearInterval(retryInterval);
            }, 10000);
        });

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
                const connectBtn = document.querySelector('#connectSection .btn');
                if (connectBtn) {
                    connectBtn.disabled = true;
                    connectBtn.innerHTML = '<span class="loading"></span> è¿æ¥ä¸­...';
                }
                
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£…åé‡è¯•');
                }

                // è¯·æ±‚è¿æ¥è´¦æˆ·
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (!accounts || accounts.length === 0) {
                        throw new Error('æœªæˆæƒè®¿é—®é’±åŒ…ï¼Œè¯·åœ¨ MetaMask ä¸­æ‰¹å‡†è¿æ¥è¯·æ±‚');
                    }
                    userAddress = accounts[0];
                } catch (requestError) {
                    if (requestError.code === 4001) {
                        // ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚
                        throw new Error('æ‚¨æ‹’ç»äº†è¿æ¥è¯·æ±‚ï¼Œè¯·ç‚¹å‡»æŒ‰é’®é‡è¯•');
                    } else {
                        throw new Error('è¿æ¥é’±åŒ…å¤±è´¥: ' + (requestError.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                }

                // åˆ›å»º provider å’Œ signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // æ£€æŸ¥ç½‘ç»œ
                showAlert('æ­£åœ¨æ£€æŸ¥ç½‘ç»œ...', 'info');
                const network = await provider.getNetwork();
                if (network.chainId !== 57054) {
                    showAlert('éœ€è¦åˆ‡æ¢åˆ° Sonic æµ‹è¯•ç½‘...', 'info');
                    await switchToSonicTestnet();
                }

                // è¿æ¥åˆçº¦
                showAlert('æ­£åœ¨è¿æ¥æ¸¸æˆåˆçº¦...', 'info');
                try {
                    bettingContract = new ethers.Contract(BETTING_CONTRACT_ADDRESS, BETTING_CONTRACT_ABI, signer);
                    
                    // æµ‹è¯•åˆçº¦è¿æ¥
                    await bettingContract.nextBetId();
                } catch (contractError) {
                    throw new Error('åˆçº¦è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿ç½‘ç»œæ­£ç¡®: ' + (contractError.message || 'æœªçŸ¥é”™è¯¯'));
                }

                // è·å– VRF è´¹ç”¨
                try {
                    vrfFee = await bettingContract.vrfFee();
                } catch (feeError) {
                    console.error('è·å–VRFè´¹ç”¨å¤±è´¥:', feeError);
                    vrfFee = ethers.utils.parseEther('0.001'); // ä½¿ç”¨é»˜è®¤å€¼
                    showAlert('è·å–VRFè´¹ç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', 'warning');
                }

                // æ›´æ–° UI
                await updateWalletInfo();
                document.getElementById('connectSection').classList.add('hidden');
                document.getElementById('bettingSection').classList.remove('hidden');
                document.getElementById('historySection').classList.remove('hidden');

                // åŠ è½½æŠ•æ³¨å†å²
                try {
                    await loadBetHistory();
                } catch (historyError) {
                    console.error('åŠ è½½æŠ•æ³¨å†å²å¤±è´¥:', historyError);
                    showAlert('åŠ è½½æŠ•æ³¨å†å²å¤±è´¥ï¼Œä½†æ‚¨ä»å¯ä»¥è¿›è¡ŒæŠ•æ³¨', 'warning');
                }

                // ç›‘å¬äº‹ä»¶
                try {
                    setupEventListeners();
                } catch (eventError) {
                    console.error('è®¾ç½®äº‹ä»¶ç›‘å¬å¤±è´¥:', eventError);
                }

                showAlert('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showAlert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
                
                // é‡ç½®UIåˆ°åˆå§‹çŠ¶æ€
                resetUIToInitialState();
            }
        }

        // åˆ‡æ¢åˆ° Sonic æµ‹è¯•ç½‘
        async function switchToSonicTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SONIC_TESTNET.chainId }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [SONIC_TESTNET]
                        });
                    } catch (addError) {
                        throw new Error('æ·»åŠ  Sonic æµ‹è¯•ç½‘å¤±è´¥');
                    }
                } else {
                    throw new Error('åˆ‡æ¢ç½‘ç»œå¤±è´¥');
                }
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        async function updateWalletInfo() {
            try {
                const balance = await provider.getBalance(userAddress);
                const network = await provider.getNetwork();

                document.getElementById('walletStatus').textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('networkStatus').textContent = network.name === 'unknown' ? 'Sonic Testnet' : network.name;
                document.getElementById('balance').textContent = `${ethers.utils.formatEther(balance).slice(0, 8)} S`;
                document.getElementById('contractStatus').textContent = 'å·²è¿æ¥';
            } catch (error) {
                console.error('æ›´æ–°é’±åŒ…ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ˜¾ç¤ºé‡‘é¢
        function updateDisplayAmounts() {
            const betAmount = document.getElementById('betAmount').value || '10';
            const tokenSelect = document.getElementById('tokenSelect').value;
            const symbol = tokenSelect === 'native' ? 'S' : (tokenSelect.includes('MLH') ? 'MLH' : 'MLHG');
            
            const vrfFeeDisplay = vrfFee ? ethers.utils.formatEther(vrfFee) : '0.001';
            const totalDisplay = tokenSelect === 'native' ? 
                (parseFloat(betAmount) + parseFloat(vrfFeeDisplay)).toFixed(3) : 
                betAmount;
            const payoutDisplay = (parseFloat(betAmount) * 1.9).toFixed(2);

            document.getElementById('displayBetAmount').textContent = `${betAmount} ${symbol}`;
            document.getElementById('displayVrfFee').textContent = `${vrfFeeDisplay} S`;
            document.getElementById('displayTotal').textContent = `${totalDisplay} ${tokenSelect === 'native' ? 'S' : symbol + ' + ' + vrfFeeDisplay + ' S'}`;
            document.getElementById('displayPayout').textContent = `${payoutDisplay} ${symbol}`;
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('betAmount').addEventListener('input', updateDisplayAmounts);
        document.getElementById('tokenSelect').addEventListener('change', updateDisplayAmounts);

        // ä¸‹æ³¨
        async function placeBet() {
            try {
                const betAmount = document.getElementById('betAmount').value;
                const tokenSelect = document.getElementById('tokenSelect').value;
                const prediction = document.querySelector('input[name="prediction"]:checked').value === 'true';

                if (!betAmount || betAmount < 1 || betAmount > 1000) {
                    throw new Error('æŠ•æ³¨é‡‘é¢å¿…é¡»åœ¨ 1-1000 ä¹‹é—´');
                }

                const betAmountWei = ethers.utils.parseEther(betAmount);
                const btn = document.getElementById('placeBetBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ä¸‹æ³¨ä¸­...';

                let tx;
                if (tokenSelect === 'native') {
                    // åŸç”Ÿä»£å¸æŠ•æ³¨
                    const totalAmount = betAmountWei.add(vrfFee);
                    tx = await bettingContract.placeBetNative(prediction, { value: totalAmount });
                } else {
                    // ERC20 ä»£å¸æŠ•æ³¨
                    const tokenContract = new ethers.Contract(tokenSelect, ERC20_ABI, signer);
                    
                    // æ£€æŸ¥æˆæƒ
                    const allowance = await tokenContract.allowance(userAddress, BETTING_CONTRACT_ADDRESS);
                    if (allowance.lt(betAmountWei)) {
                        showAlert('æ­£åœ¨æˆæƒä»£å¸...', 'info');
                        const approveTx = await tokenContract.approve(BETTING_CONTRACT_ADDRESS, betAmountWei);
                        await approveTx.wait();
                    }
                    
                    tx = await bettingContract.placeBetToken(tokenSelect, betAmountWei, prediction, { value: vrfFee });
                }

                showAlert('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                const receipt = await tx.wait();
                
                showAlert('ä¸‹æ³¨æˆåŠŸï¼ç­‰å¾… 50 ä¸ªåŒºå—åè‡ªåŠ¨æŠ•æ·éª°å­', 'success');
                
                // é‡ç½®è¡¨å•
                document.getElementById('betAmount').value = '10';
                updateDisplayAmounts();
                
                // åˆ·æ–°å†å²è®°å½•
                await loadBetHistory();
                await updateWalletInfo();

            } catch (error) {
                console.error('ä¸‹æ³¨å¤±è´¥:', error);
                showAlert('ä¸‹æ³¨å¤±è´¥: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('placeBetBtn');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ² ä¸‹æ³¨';
            }
        }

        // åŠ è½½æŠ•æ³¨å†å²
        async function loadBetHistory() {
            try {
                const betIds = await bettingContract.getPlayerBets(userAddress);
                const container = document.getElementById('betHistoryContainer');
                
                if (betIds.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŠ•æ³¨è®°å½•</div>';
                    return;
                }

                let historyHtml = '';
                for (let i = betIds.length - 1; i >= 0; i--) {
                    const betId = betIds[i];
                    const bet = await bettingContract.getBetRecord(betId);
                    const canRequest = await bettingContract.canRequestDiceRoll(betId);
                    
                    const tokenSymbol = bet.tokenAddress === ethers.constants.AddressZero ? 'S' : 
                        (bet.tokenAddress.toLowerCase().includes('mlhg') ? 'MLHG' : 'MLH');
                    
                    let statusClass = '';
                    let statusText = '';
                    let actionButton = '';
                    
                    if (bet.isSettled) {
                        statusClass = bet.isWinner ? 'winner' : 'loser';
                        statusText = bet.isWinner ? 'ğŸ‰ ä¸­å¥–' : 'ğŸ˜” æœªä¸­å¥–';
                    } else if (bet.diceRollCompleted) {
                        statusText = 'ğŸ² ç­‰å¾…ç»“æœ';
                    } else if (canRequest) {
                        statusText = 'â° å¯æŠ•æ·éª°å­';
                        actionButton = `<button class="btn btn-warning" onclick="requestDiceRoll(${betId})">æŠ•æ·éª°å­</button>`;
                    } else {
                        statusText = 'â³ ç­‰å¾…ç¡®è®¤';
                    }

                    historyHtml += `
                        <div class="bet-item ${statusClass}">
                            <div class="bet-details">
                                <div><strong>æŠ•æ³¨ID:</strong> ${betId}</div>
                                <div><strong>é‡‘é¢:</strong> ${ethers.utils.formatEther(bet.amount)} ${tokenSymbol}</div>
                                <div><strong>é¢„æµ‹:</strong> ${bet.predictedIsEven ? 'åŒæ•°' : 'å•æ•°'}</div>
                                <div><strong>çŠ¶æ€:</strong> ${statusText}</div>
                                <div><strong>æ—¶é—´:</strong> ${new Date(bet.timestamp * 1000).toLocaleString()}</div>
                            </div>
                            ${actionButton}
                        </div>
                    `;
                }
                
                container.innerHTML = historyHtml;
            } catch (error) {
                console.error('åŠ è½½æŠ•æ³¨å†å²å¤±è´¥:', error);
            }
        }

        // è¯·æ±‚éª°å­æŠ•æ·
        async function requestDiceRoll(betId) {
            try {
                showAlert('æ­£åœ¨è¯·æ±‚éª°å­æŠ•æ·...', 'info');
                const tx = await bettingContract.requestDiceRoll(betId);
                await tx.wait();
                showAlert('éª°å­æŠ•æ·è¯·æ±‚æˆåŠŸï¼', 'success');
                await loadBetHistory();
            } catch (error) {
                console.error('è¯·æ±‚éª°å­æŠ•æ·å¤±è´¥:', error);
                showAlert('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°å†å²è®°å½•
        async function refreshHistory() {
            await loadBetHistory();
            showAlert('å†å²è®°å½•å·²åˆ·æ–°', 'success');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // ç›‘å¬æŠ•æ³¨äº‹ä»¶
            bettingContract.on('BetPlaced', (betId, player, tokenAddress, amount, predictedIsEven, timestamp) => {
                if (player.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert(`æŠ•æ³¨æˆåŠŸï¼æŠ•æ³¨ID: ${betId}`, 'success');
                    loadBetHistory();
                }
            });

            // ç›‘å¬ç»“ç®—äº‹ä»¶
            bettingContract.on('BetSettled', (betId, player, diceRequestId, actualIsEven, isWinner, payout, timestamp) => {
                if (player.toLowerCase() === userAddress.toLowerCase()) {
                    const result = isWinner ? 'ğŸ‰ æ­å–œä¸­å¥–ï¼' : 'ğŸ˜” å¾ˆé—æ†¾æœªä¸­å¥–';
                    const resultText = actualIsEven ? 'åŒæ•°' : 'å•æ•°';
                    showAlert(`æŠ•æ³¨ ${betId} ç»“æœ: ${resultText} - ${result}`, isWinner ? 'success' : 'error');
                    loadBetHistory();
                    updateWalletInfo();
                }
            });
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            container.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    userAddress = accounts[0];
                    updateWalletInfo();
                    loadBetHistory();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                location.reload();
            });
        }
    </script>
</body>
</html>